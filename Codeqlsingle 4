import os
from github import Github

# GitHub personal access token
access_token = os.getenv('GITHUB_TOKEN')

# GitHub organization name
org_name = 'your_organization_name'

# GitHub repository name
repo_name = 'your_repository_name'

def check_codeql_workflow_enabled(repo):
    workflows = repo.get_workflows()
    for workflow in workflows:
        if workflow.name == 'CodeQL':
            return True
    return False

def open_pull_request():
    g = Github(access_token)
    repo = g.get_repo(f"{org_name}/{repo_name}")

    print(f"Checking if CODEQL workflow is enabled in {repo.full_name}...")
    if not check_codeql_workflow_enabled(repo):
        print(f"CODEQL workflow not enabled in {repo.full_name}, skipping...")
        return

    print(f"CODEQL workflow enabled in {repo.full_name}. Checking if pull request already exists...")
    existing_prs = repo.get_pulls(state='open', head=f'{org_name}:add-codeql-workflow-badge')
    if existing_prs.totalCount > 0:
        print(f"Pull request already exists in {repo.full_name}, skipping...")
        return

    print(f"No existing pull request found. Creating new branch...")
    main_branch = repo.get_branch("main")
    new_branch = repo.create_git_ref(f"refs/heads/add-codeql-workflow-badge", main_branch.commit.sha)

    print(f"New branch created successfully. Opening pull request...")
    pr_title = "Add CODEQL workflow status badge"
    pr_body = "This pull request adds a CODEQL workflow status badge to the repository."
    repo.create_pull(title=pr_title, body=pr_body, head="add-codeql-workflow-badge", base="main")
    print(f"Pull request opened successfully in {repo.full_name}")

if __name__ == "__main__":
    open_pull_request()
