import os
from github import Github

# GitHub personal access token
access_token = os.getenv('GITHUB_TOKEN')

# GitHub organization name
org_name = 'your_organization_name'

# GitHub repository name
repo_name = 'your_repository_name'

# CODEQL badge markdown
codeql_badge_markdown = '[![CODEQL](https://img.shields.io/badge/CODEQL-passing-brightgreen)](https://github.com/{org}/{repo}/actions/workflows/codeql.yml)'

def check_codeql_workflow_enabled(repo):
    workflows = repo.get_workflows()
    for workflow in workflows:
        if workflow.name == 'CodeQL':
            return True
    return False

def open_pull_request():
    g = Github(access_token)
    repo = g.get_repo(f"{org_name}/{repo_name}")

    print(f"Checking if CODEQL workflow is enabled in {repo.full_name}...")
    if not check_codeql_workflow_enabled(repo):
        print(f"CODEQL workflow not enabled in {repo.full_name}, skipping...")
        return

    print(f"CODEQL workflow enabled in {repo.full_name}. Checking if pull request already exists...")
    existing_prs = repo.get_pulls(state='open', head=f'{org_name}:add-codeql-workflow-badge')
    if existing_prs.totalCount > 0:
        print(f"Pull request already exists in {repo.full_name}, skipping...")
        return

    print(f"No existing pull request found. Creating new branch and opening pull request...")

    # Get the default branch and its latest commit
    default_branch = repo.get_branch(repo.default_branch)
    latest_commit_sha = default_branch.commit.sha

    # Create new branch
    new_branch_name = "add-codeql-workflow-badge"
    try:
        new_branch = repo.create_git_ref(f"refs/heads/{new_branch_name}", latest_commit_sha)
        print(f"New branch '{new_branch_name}' created successfully.")
    except Exception as e:
        print(f"Error creating new branch: {e}")
        return

    # Update README in the new branch
    try:
        readme = repo.get_readme()
        readme_content = readme.decoded_content.decode("utf-8")
        if 'CODEQL' not in readme_content:
            new_readme_content = readme_content + '\n\n' + codeql_badge_markdown
            repo.create_file(path=readme.path, message='Add CODEQL workflow status badge', content=new_readme_content, branch=new_branch_name)
            print(f"CODEQL badge added to README in new branch '{new_branch_name}' of {repo.full_name}")
        else:
            print(f"CODEQL badge already exists in README in {repo.full_name}, skipping...")
    except Exception as e:
        print(f"Error updating README: {e}")
        return

    # Open pull request
    try:
        pr_title = "Add CODEQL workflow status badge"
        pr_body = "This pull request adds a CODEQL workflow status badge to the repository."
        repo.create_pull(title=pr_title, body=pr_body, head=new_branch_name, base=repo.default_branch)
        print(f"Pull request opened successfully in {repo.full_name}")
    except Exception as e:
        print(f"Error opening pull request: {e}")

if __name__ == "__main__":
    open_pull_request()
